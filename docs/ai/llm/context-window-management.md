# ä¸Šä¸‹æ–‡çª—å£ç®¡ç†ç­–ç•¥

> ä¸Šä¸‹æ–‡çª—å£æ˜¯ LLM æœ€é‡è¦çš„é™åˆ¶ä¹‹ä¸€ã€‚å¦‚ä½•åœ¨æœ‰é™çš„çª—å£å†…æ”¾å…¥æœ€æœ‰ä»·å€¼çš„ä¿¡æ¯ï¼Œæ˜¯ LLM åº”ç”¨å·¥ç¨‹åŒ–çš„æ ¸å¿ƒé—®é¢˜ã€‚

---

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡çª—å£

**ä¸Šä¸‹æ–‡çª—å£ = è¾“å…¥ + è¾“å‡ºçš„ token æ€»é‡é™åˆ¶**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ä¸Šä¸‹æ–‡çª—å£ï¼ˆå¦‚ 128Kï¼‰            â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     è¾“å…¥         â”‚  â”‚     è¾“å‡º        â”‚  â”‚
â”‚  â”‚  System Prompt  â”‚  â”‚   æ¨¡å‹å›å¤      â”‚  â”‚
â”‚  â”‚  å†å²å¯¹è¯       â”‚  â”‚                 â”‚  â”‚
â”‚  â”‚  ç”¨æˆ·è¾“å…¥       â”‚  â”‚                 â”‚  â”‚
â”‚  â”‚  ä¸Šä¸‹æ–‡æ•°æ®     â”‚  â”‚                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å„æ¨¡å‹ä¸Šä¸‹æ–‡çª—å£

| æ¨¡å‹ | ä¸Šä¸‹æ–‡çª—å£ | å¤‡æ³¨ |
|------|-----------|------|
| GPT-4 | 8K / 32K | åŸºç¡€ç‰ˆ / 32K ç‰ˆ |
| GPT-4 Turbo | 128K | æ¨èä½¿ç”¨ |
| GPT-3.5 Turbo | 16K | æ€§ä»·æ¯”é«˜ |
| Claude 3 Opus | 200K | è¶…é•¿ä¸Šä¸‹æ–‡ |
| Claude 3 Sonnet | 200K | æ€§ä»·æ¯”ç‰ˆ |

### ä¸ºä»€ä¹ˆä¸Šä¸‹æ–‡ç®¡ç†é‡è¦

1. **æˆæœ¬**ï¼šè¾“å…¥ token ä¹Ÿè¦ä»˜è´¹
2. **å»¶è¿Ÿ**ï¼šè¾“å…¥è¶Šé•¿ï¼Œå“åº”è¶Šæ…¢
3. **æ³¨æ„åŠ›ç¨€é‡Š**ï¼šå¤ªå¤šå†…å®¹ä¼šé™ä½å¯¹å…³é”®ä¿¡æ¯çš„å…³æ³¨
4. **ç¡¬é™åˆ¶**ï¼šè¶…å‡ºçª—å£ä¼šæŠ¥é”™

---

## ğŸ“Š ä¿¡æ¯ä¼˜å…ˆçº§æ¡†æ¶

### åˆ†å±‚æ¨¡å‹

```
ä¼˜å…ˆçº§é«˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä¼˜å…ˆçº§ä½

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ ¸å¿ƒ   â”‚ â”‚ ä¸Šä¸‹æ–‡ â”‚ â”‚ å†å²   â”‚ â”‚ è¡¥å……   â”‚
â”‚ æŒ‡ä»¤   â”‚ â”‚ æ•°æ®   â”‚ â”‚ å¯¹è¯   â”‚ â”‚ ä¿¡æ¯   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚          â”‚          â”‚          â”‚
    â–¼          â–¼          â–¼          â–¼
 å¿…é¡»ä¿ç•™   æŒ‰éœ€ç²¾é€‰   å¯å‹ç¼©/æˆªæ–­  å¯ä¸¢å¼ƒ
```

### å„ç±»å†…å®¹çš„ç­–ç•¥

| å†…å®¹ç±»å‹ | ä¼˜å…ˆçº§ | ç­–ç•¥ |
|----------|--------|------|
| System Prompt | æœ€é«˜ | ç²¾ç®€ä½†å®Œæ•´ |
| å½“å‰ä»»åŠ¡è¾“å…¥ | é«˜ | å¿…é¡»åŒ…å« |
| ç›´æ¥ç›¸å…³ä¸Šä¸‹æ–‡ | é«˜ | ç²¾é€‰å…³é”®éƒ¨åˆ† |
| æœ€è¿‘å¯¹è¯å†å² | ä¸­ | ä¿ç•™æ‘˜è¦ |
| æ—©æœŸå¯¹è¯å†å² | ä½ | å‹ç¼©æˆ–ä¸¢å¼ƒ |
| ç¤ºä¾‹/å‚è€ƒ | ä¸­ | æŒ‰éœ€åŠ è½½ |

---

## ğŸ”§ ç®¡ç†ç­–ç•¥

### ç­–ç•¥ 1ï¼šæ»‘åŠ¨çª—å£

ä¿ç•™æœ€è¿‘çš„ N è½®å¯¹è¯ã€‚

```javascript
class SlidingWindowManager {
  constructor(maxTurns = 10) {
    this.maxTurns = maxTurns;
    this.history = [];
  }
  
  addTurn(userMessage, assistantMessage) {
    this.history.push({ user: userMessage, assistant: assistantMessage });
    
    // ä¿ç•™æœ€è¿‘çš„ N è½®
    if (this.history.length > this.maxTurns) {
      this.history = this.history.slice(-this.maxTurns);
    }
  }
  
  getMessages(systemPrompt) {
    const messages = [{ role: "system", content: systemPrompt }];
    
    for (const turn of this.history) {
      messages.push({ role: "user", content: turn.user });
      messages.push({ role: "assistant", content: turn.assistant });
    }
    
    return messages;
  }
}
```

**ä¼˜ç‚¹**ï¼šç®€å•ç›´æ¥
**ç¼ºç‚¹**ï¼šå¯èƒ½ä¸¢å¤±æ—©æœŸé‡è¦ä¿¡æ¯

### ç­–ç•¥ 2ï¼šæ‘˜è¦å‹ç¼©

å®šæœŸå°†å†å²å¯¹è¯å‹ç¼©ä¸ºæ‘˜è¦ã€‚

```javascript
class SummaryManager {
  constructor(client, summaryThreshold = 5) {
    this.client = client;
    this.summaryThreshold = summaryThreshold;
    this.summary = "";
    this.recentHistory = [];
  }
  
  async addTurn(userMessage, assistantMessage) {
    this.recentHistory.push({ user: userMessage, assistant: assistantMessage });
    
    // è¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œç”Ÿæˆæ‘˜è¦
    if (this.recentHistory.length >= this.summaryThreshold) {
      await this.compressTurn();
    }
  }
  
  async compressTurn() {
    const historyText = this.recentHistory
      .map(t => `ç”¨æˆ·: ${t.user}\nåŠ©æ‰‹: ${t.assistant}`)
      .join('\n\n');
    
    const newSummary = await this.client.chat.completions.create({
      model: "gpt-3.5-turbo",  // ç”¨ä¾¿å®œçš„æ¨¡å‹åšæ‘˜è¦
      messages: [
        {
          role: "system",
          content: "è¯·å°†ä»¥ä¸‹å¯¹è¯å†å²å‹ç¼©ä¸ºç®€æ´çš„æ‘˜è¦ï¼Œä¿ç•™å…³é”®ä¿¡æ¯å’Œå†³ç­–ã€‚"
        },
        {
          role: "user",
          content: `ä¹‹å‰çš„æ‘˜è¦ï¼š${this.summary || "æ— "}\n\næ–°å¯¹è¯ï¼š\n${historyText}`
        }
      ],
      max_tokens: 500
    });
    
    this.summary = newSummary.choices[0].message.content;
    this.recentHistory = [];
  }
  
  getMessages(systemPrompt, currentInput) {
    const messages = [{ role: "system", content: systemPrompt }];
    
    // æ·»åŠ æ‘˜è¦ï¼ˆå¦‚æœ‰ï¼‰
    if (this.summary) {
      messages.push({
        role: "system",
        content: `å¯¹è¯å†å²æ‘˜è¦ï¼š${this.summary}`
      });
    }
    
    // æ·»åŠ æœ€è¿‘å†å²
    for (const turn of this.recentHistory) {
      messages.push({ role: "user", content: turn.user });
      messages.push({ role: "assistant", content: turn.assistant });
    }
    
    // æ·»åŠ å½“å‰è¾“å…¥
    messages.push({ role: "user", content: currentInput });
    
    return messages;
  }
}
```

### ç­–ç•¥ 3ï¼šToken é¢„ç®—ç®¡ç†

ç²¾ç¡®æ§åˆ¶æ¯éƒ¨åˆ†çš„ token é¢„ç®—ã€‚

```javascript
class TokenBudgetManager {
  constructor(maxTokens, budgetAllocation) {
    this.maxTokens = maxTokens;
    this.budget = budgetAllocation;
    // ä¾‹å¦‚ï¼š{ system: 0.1, context: 0.4, history: 0.3, output: 0.2 }
  }
  
  allocate() {
    return {
      system: Math.floor(this.maxTokens * this.budget.system),
      context: Math.floor(this.maxTokens * this.budget.context),
      history: Math.floor(this.maxTokens * this.budget.history),
      output: Math.floor(this.maxTokens * this.budget.output),
    };
  }
  
  fitTobudget(content, budget) {
    const currentTokens = countTokens(content);
    
    if (currentTokens <= budget) {
      return content;
    }
    
    // æˆªæ–­ç­–ç•¥ï¼šä¼˜å…ˆä¿ç•™å¼€å¤´å’Œç»“å°¾
    const ratio = budget / currentTokens;
    const keepFromStart = Math.floor(content.length * ratio * 0.7);
    const keepFromEnd = Math.floor(content.length * ratio * 0.3);
    
    return content.slice(0, keepFromStart) + 
           "\n...[å†…å®¹å·²æˆªæ–­]...\n" + 
           content.slice(-keepFromEnd);
  }
  
  buildMessages(systemPrompt, context, history, userInput) {
    const allocation = this.allocate();
    
    return [
      { 
        role: "system", 
        content: this.fitTobudget(systemPrompt, allocation.system) 
      },
      { 
        role: "system", 
        content: `ç›¸å…³ä¸Šä¸‹æ–‡ï¼š\n${this.fitTobudget(context, allocation.context)}` 
      },
      ...this.fitHistoryTobudget(history, allocation.history),
      { role: "user", content: userInput }
    ];
  }
  
  fitHistoryTobudget(history, budget) {
    const messages = [];
    let usedTokens = 0;
    
    // ä»æœ€è¿‘çš„å¼€å§‹æ·»åŠ 
    for (let i = history.length - 1; i >= 0; i--) {
      const turn = history[i];
      const turnTokens = countTokens(turn.user + turn.assistant);
      
      if (usedTokens + turnTokens > budget) break;
      
      messages.unshift(
        { role: "user", content: turn.user },
        { role: "assistant", content: turn.assistant }
      );
      usedTokens += turnTokens;
    }
    
    return messages;
  }
}
```

### ç­–ç•¥ 4ï¼šRAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰

ä¸æŠŠæ‰€æœ‰ä¿¡æ¯æ”¾å…¥ä¸Šä¸‹æ–‡ï¼Œè€Œæ˜¯åŠ¨æ€æ£€ç´¢ç›¸å…³å†…å®¹ã€‚

```javascript
class RAGManager {
  constructor(vectorStore, topK = 5) {
    this.vectorStore = vectorStore;
    this.topK = topK;
  }
  
  async buildContext(query) {
    // 1. æ£€ç´¢æœ€ç›¸å…³çš„æ–‡æ¡£ç‰‡æ®µ
    const relevantChunks = await this.vectorStore.search(query, this.topK);
    
    // 2. ç»„è£…ä¸Šä¸‹æ–‡
    const context = relevantChunks
      .map(chunk => `[æ¥æº: ${chunk.source}]\n${chunk.content}`)
      .join('\n\n---\n\n');
    
    return context;
  }
  
  async buildMessages(systemPrompt, userQuery) {
    const context = await this.buildContext(userQuery);
    
    return [
      { role: "system", content: systemPrompt },
      {
        role: "system",
        content: `ä»¥ä¸‹æ˜¯ä¸ç”¨æˆ·é—®é¢˜ç›¸å…³çš„å‚è€ƒèµ„æ–™ï¼š\n\n${context}\n\nè¯·åŸºäºä»¥ä¸Šèµ„æ–™å›ç­”ç”¨æˆ·é—®é¢˜ã€‚å¦‚æœèµ„æ–™ä¸­æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œè¯·æ˜ç¡®è¯´æ˜ã€‚`
      },
      { role: "user", content: userQuery }
    ];
  }
}
```

---

## ğŸ“‹ å†…å®¹å‹ç¼©æŠ€æœ¯

### æŠ€æœ¯ 1ï¼šæ–‡æœ¬æ‘˜è¦

```javascript
async function summarizeContent(content, targetLength = 500) {
  if (countTokens(content) <= targetLength) {
    return content;
  }
  
  const response = await client.chat.completions.create({
    model: "gpt-3.5-turbo",
    messages: [
      {
        role: "system",
        content: `è¯·å°†ä»¥ä¸‹å†…å®¹å‹ç¼©åˆ°çº¦ ${targetLength} tokenï¼Œä¿ç•™å…³é”®ä¿¡æ¯ã€‚`
      },
      { role: "user", content: content }
    ],
    max_tokens: targetLength
  });
  
  return response.choices[0].message.content;
}
```

### æŠ€æœ¯ 2ï¼šç»“æ„åŒ–æå–

å°†éç»“æ„åŒ–å†…å®¹è½¬ä¸ºç»“æ„åŒ–ï¼Œæ›´ç´§å‡‘ã€‚

```javascript
async function extractStructured(document) {
  const response = await client.chat.completions.create({
    model: "gpt-3.5-turbo",
    messages: [
      {
        role: "system",
        content: "æå–æ–‡æ¡£çš„å…³é”®ä¿¡æ¯ï¼Œè¾“å‡º JSON æ ¼å¼ã€‚"
      },
      { role: "user", content: document }
    ],
    response_format: { type: "json_object" }
  });
  
  return JSON.parse(response.choices[0].message.content);
}

// åŸæ–‡ï¼š1000 token çš„ä¼šè®®è®°å½•
// å‹ç¼©åï¼š
{
  "date": "2024-03-15",
  "participants": ["Alice", "Bob", "Carol"],
  "decisions": [
    "é‡‡ç”¨ React æŠ€æœ¯æ ˆ",
    "ä¸‹å‘¨ä¸€å®Œæˆè®¾è®¡è¯„å®¡"
  ],
  "action_items": [
    { "owner": "Alice", "task": "ç¼–å†™æŠ€æœ¯æ–¹æ¡ˆ", "due": "3/18" }
  ]
}
// çº¦ 100 token
```

### æŠ€æœ¯ 3ï¼šä»£ç å‹ç¼©

```javascript
function compressCode(code, options = {}) {
  const { keepComments = false, keepTypes = true } = options;
  
  let compressed = code;
  
  // ç§»é™¤æ³¨é‡Š
  if (!keepComments) {
    compressed = compressed.replace(/\/\*[\s\S]*?\*\/|\/\/.*/g, '');
  }
  
  // ç§»é™¤ç©ºè¡Œ
  compressed = compressed.replace(/^\s*[\r\n]/gm, '');
  
  // å‹ç¼©ç©ºæ ¼
  compressed = compressed.replace(/\s+/g, ' ');
  
  return compressed.trim();
}

// æˆ–è€…åªæå–å‡½æ•°ç­¾å
function extractSignatures(code) {
  // æå–å‡½æ•°ç­¾åï¼Œä¸åŒ…å«å®ç°
  const signaturePattern = /(?:export\s+)?(?:async\s+)?function\s+\w+\([^)]*\)(?::\s*[^{]+)?/g;
  return code.match(signaturePattern) || [];
}
```

---

## âš ï¸ å¸¸è§é™·é˜±

### é™·é˜± 1ï¼šLost in the Middle

ç ”ç©¶è¡¨æ˜ï¼ŒLLM å¯¹ä¸Šä¸‹æ–‡ä¸­é—´éƒ¨åˆ†çš„å…³æ³¨åº¦è¾ƒä½ã€‚

```
ä¸Šä¸‹æ–‡ä½ç½® vs æ³¨æ„åŠ›ï¼š
å¼€å¤´ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ é«˜
ä¸­é—´ â–ˆâ–ˆâ–ˆâ–ˆ ä½
ç»“å°¾ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ è¾ƒé«˜
```

**è§£æ³•**ï¼šé‡è¦ä¿¡æ¯æ”¾åœ¨å¼€å¤´å’Œç»“å°¾

```javascript
function optimizeContextOrder(items) {
  // æŒ‰é‡è¦æ€§æ’åºåï¼Œäº¤æ›¿æ”¾ç½®
  const sorted = items.sort((a, b) => b.importance - a.importance);
  const result = [];
  
  for (let i = 0; i < sorted.length; i++) {
    if (i % 2 === 0) {
      result.unshift(sorted[i]);  // æ”¾å¼€å¤´
    } else {
      result.push(sorted[i]);     // æ”¾ç»“å°¾
    }
  }
  
  return result;
}
```

### é™·é˜± 2ï¼šä¸Šä¸‹æ–‡æ±¡æŸ“

æ— å…³ä¿¡æ¯å¹²æ‰°æ¨¡å‹åˆ¤æ–­ã€‚

```javascript
// âŒ å¡å…¥å¤ªå¤šæ— å…³ä¿¡æ¯
const context = getAllUserData(userId);  // åŒ…å«å¾ˆå¤šæ— å…³å­—æ®µ

// âœ… åªé€‰æ‹©ç›¸å…³ä¿¡æ¯
const context = {
  name: user.name,
  recentOrders: user.orders.slice(-3),
  preferences: user.preferences
};
```

### é™·é˜± 3ï¼šç¡¬æˆªæ–­å¯¼è‡´ä¿¡æ¯ä¸¢å¤±

```javascript
// âŒ ç®€å•æˆªæ–­å¯èƒ½åˆ‡æ–­é‡è¦ä¿¡æ¯
const truncated = content.slice(0, maxLength);

// âœ… æ™ºèƒ½æˆªæ–­ï¼šä¿æŒå®Œæ•´æ€§
function smartTruncate(content, maxTokens) {
  const tokens = encode(content);
  
  if (tokens.length <= maxTokens) {
    return content;
  }
  
  // æ‰¾åˆ°æœ€è¿‘çš„å¥å­è¾¹ç•Œ
  const truncatedTokens = tokens.slice(0, maxTokens);
  let text = decode(truncatedTokens);
  
  // å›é€€åˆ°æœ€åä¸€ä¸ªå®Œæ•´å¥å­
  const lastSentence = text.lastIndexOf('ã€‚');
  if (lastSentence > text.length * 0.8) {
    text = text.slice(0, lastSentence + 1);
  }
  
  return text + '\n[å†…å®¹å·²æˆªæ–­]';
}
```

---

## ğŸ’¡ å®è·µå»ºè®®

### ä¼°ç®—å…¬å¼

```javascript
// é¢„ç•™è¶³å¤Ÿçš„è¾“å‡ºç©ºé—´
const safeInputLimit = modelContextWindow - expectedOutputTokens - buffer;

// ä¾‹å¦‚ï¼š128K çª—å£ï¼ŒæœŸæœ›è¾“å‡º 4Kï¼Œé¢„ç•™ 2K ç¼“å†²
const safeInputLimit = 128000 - 4000 - 2000;  // = 122000
```

### ç›‘æ§ä¸Šä¸‹æ–‡ä½¿ç”¨

```javascript
class ContextMonitor {
  constructor(modelLimit) {
    this.modelLimit = modelLimit;
    this.stats = [];
  }
  
  record(inputTokens, outputTokens) {
    this.stats.push({
      timestamp: Date.now(),
      inputTokens,
      outputTokens,
      utilization: (inputTokens + outputTokens) / this.modelLimit
    });
  }
  
  getReport() {
    return {
      avgUtilization: average(this.stats.map(s => s.utilization)),
      maxUtilization: Math.max(...this.stats.map(s => s.utilization)),
      nearLimitCount: this.stats.filter(s => s.utilization > 0.9).length
    };
  }
}
```

---

## ğŸ“š ç›¸å…³ç¬”è®°

- [LLM API ä½¿ç”¨æœ€ä½³å®è·µ](llm-api-best-practices.md)
- [æç¤ºè¯å·¥ç¨‹åŸºç¡€](../prompting/prompt-engineering-fundamentals.md)
- [å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](../troubleshooting/common-llm-issues.md)

---

## å‚è€ƒèµ„æ–™

- [Lost in the Middle](https://arxiv.org/abs/2307.03172)
- [RAG Overview](https://docs.llamaindex.ai/en/stable/getting_started/concepts/)
- [Context Window Best Practices](https://platform.openai.com/docs/guides/text-generation/chat-completions-api)
